# CAD границы поверх облака точек (CloudCompare vs свой просмотрщик)

План: сделать утилиту, которая конвертирует CAD-границы в набор точек для наложения в CloudCompare, учитывая что **СК — МСК и она может отличаться для каждого объекта**.

## 1) Рекомендация по архитектуре

### Предпочтительно: утилита-конвертер + CloudCompare (CLI)
- **Почему**:
  - CloudCompare уже решает тяжелое: визуализация больших LAS/LAZ, работа с геопривязкой, фильтры/сегментация.
  - Вам не нужно писать свой 3D-движок/рендер/LOD/интеракции.
  - Можно автоматизировать пакетно через **CloudCompare CLI** (и/или pycc, если используется).
- **Что пишем**: отдельную программу (Python/CLI), которая:
  - читает CAD (лучше DXF), достает полилинии/полигоны границ;
  - приводит координаты в ту же СК, что облако;
  - назначает высоту (Z) одним из простых методов;
  - экспортирует в формат, который CloudCompare надежно открывает (ASCII point set / polyline format, либо OBJ/PLY).

### Не рекомендуется на MVP: Python-плагин внутри CloudCompare
- **Почему**:
  - Python-интеграция в CloudCompare зависит от сборки (pycc/плагины), сложнее в поддержке и распространении.
  - Для “просто показать” проще иметь внешнюю утилиту и запускать CC с параметрами.

### Не рекомендуется на MVP: свой просмотрщик облаков
- **Почему**:
  - Самое дорогое по времени: поддержка LAS/LAZ (потоковое чтение), LOD/октодерево, камеры, выбор СК, большие объемы.
  - Риск получить медленно/нестабильно по сравнению с CC.

## 2) MVP функциональность (первый рабочий результат)

### 2.1 Входные данные
- **Облако**: LAS/LAZ (основной), опционально E57/PLY.
- **Границы**: DXF (предпочтительно), DWG через конвертацию в DXF (вне программы).

### 2.1.1 СК/геопривязка (важно для МСК)
- Предполагаем, что **DXF уже в геодезических XY** (как у облака), но **код/описание МСК может отличаться между объектами**.
- В MVP утилита должна принимать параметры СК как вход:
  - `--cloud-crs` и `--cad-crs` (строка PROJ или EPSG), либо
  - `--assume-same-crs` (если уверены, что CAD и облако в одной МСК).
- Если `cad-crs == cloud-crs`, трансформация не нужна.

### 2.2 Выходные данные
- Файл для наложения в CloudCompare:
  - вариант A (MVP): `граница_as_points.xyz` (точки вдоль полилинии) + “соединение визуально” (цвет/размер точек)

### 2.3 Назначение высоты (Z) в MVP
- **Z-константа**:
  - Z = среднее/медиана по облаку в пределах bbox границы, или
  - Z = percentile (например p95) + небольшой оффсет, чтобы линия была видна сверху.
- **Важно**: этот метод не требует ground-классификации и уже решает вашу текущую цель “визуально”.

### 2.4 Дискретизация границы в точки (MVP)
- Извлечь из DXF полилинии/полигоны границы.
- Уплотнить сегменты с шагом `--step-m` (например 0.5–2.0 м) -> получить список XY.
- Назначить всем точкам Z по методу из 2.3.

## 3) Опционально (следующая итерация): “по рельефу”

### 3.1 Автоматическое приближение по поверхности без полной классификации
- Уплотнить полилинию до шага 0.2–1.0 м.
- Для каждой точки искать высоту по локальным соседям облака:
  - взять k ближайших точек или точки в радиусе R;
  - Z = минимум/квантиль (например p10) для приближения к земле (устойчиво к кустам/мусору лучше чем min);
  - добавить оффсет +0.05…+0.2 м.

### 3.2 Вариант с ground-классификацией (если качество нужно выше)
- Встроенные инструменты CloudCompare (CSF / Cloth Simulation Filter) в пакетном режиме (если доступны в вашей сборке) -> получить ground subset.
- Потом “драпировать” границу по ground subset тем же методом соседей (будет стабильнее).

## 4) Технические решения/библиотеки (предложение)
- **DXF парсинг**: `ezdxf` (читает полилинии/LWPOLYLINE, поддерживает DXF надежно).
- **LAS/LAZ чтение**: `laspy` + `lazrs` (или `laszip`), чтобы LAZ работал.
- **Поиск соседей**: `scipy.spatial.cKDTree` или `sklearn.neighbors.KDTree`.
- **СК/проекции**: `pyproj`.

## 5) Уточняющие вопросы (нужны до реализации)
1) Как вы хотите задавать МСК для каждого объекта: EPSG, PROJ-строкой, или через “готовые пресеты” (список МСК зон)?
2) Достаточно ли в MVP режима `--assume-same-crs` (CAD и облако в одной МСК без пересчета)?
3) Нужна ли поддержка *нескольких* границ в одном DXF (слои/несколько полилиний) и как их различать (по layer/name)?

## 6) Критерии готовности MVP
- Утилита принимает: `cloud.laz` + `boundary.dxf`.
- На выходе: файл границы (XYZ/PLY/OBJ) в нужной СК.
- Открытие в CloudCompare показывает границы поверх облака (с корректным положением в плане).
